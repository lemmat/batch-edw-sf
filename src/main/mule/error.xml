<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core"
	xmlns="http://www.mulesoft.org/schema/mule/core"
	xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd">
	<error-handler name="api-error-handler">

		<on-error-propagate type="APIKIT:BAD_REQUEST">
			<ee:transform
				xsi:schemaLocation="http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd">
				<ee:message>
					<ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
	message: "Bad request",
	desscription: error.description
}]]></ee:set-payload>
				</ee:message>
				<ee:variables>
					<ee:set-variable variableName="httpStatus"><![CDATA[400]]></ee:set-variable>
				</ee:variables>
			</ee:transform>
		</on-error-propagate>
		<on-error-propagate type="APIKIT:NOT_FOUND">
			<ee:transform
				xsi:schemaLocation="http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd">
				<ee:message>
					<ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{message: "Resource not found"}]]></ee:set-payload>
				</ee:message>
				<ee:variables>
					<ee:set-variable variableName="httpStatus">404</ee:set-variable>
				</ee:variables>
			</ee:transform>
		</on-error-propagate>
		<on-error-propagate
			type="APIKIT:METHOD_NOT_ALLOWED">
			<ee:transform
				xsi:schemaLocation="http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd">
				<ee:message>
					<ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{message: "Method not allowed"}]]></ee:set-payload>
				</ee:message>
				<ee:variables>
					<ee:set-variable variableName="httpStatus">405</ee:set-variable>
				</ee:variables>
			</ee:transform>
		</on-error-propagate>
		<on-error-propagate type="APIKIT:NOT_ACCEPTABLE">
			<ee:transform
				xsi:schemaLocation="http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd">
				<ee:message>
					<ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{message: "Not acceptable"}]]></ee:set-payload>
				</ee:message>
				<ee:variables>
					<ee:set-variable variableName="httpStatus">406</ee:set-variable>
				</ee:variables>
			</ee:transform>
		</on-error-propagate>
		<on-error-propagate
			type="APIKIT:UNSUPPORTED_MEDIA_TYPE">
			<ee:transform
				xsi:schemaLocation="http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd">
				<ee:message>
					<ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{message: "Unsupported media type"}]]></ee:set-payload>
				</ee:message>
				<ee:variables>
					<ee:set-variable variableName="httpStatus">415</ee:set-variable>
				</ee:variables>
			</ee:transform>
		</on-error-propagate>
		<on-error-propagate type="APIKIT:NOT_IMPLEMENTED">
			<ee:transform
				xsi:schemaLocation="http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd">
				<ee:message>
					<ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{message: "Not Implemented"}]]></ee:set-payload>
				</ee:message>
				<ee:variables>
					<ee:set-variable variableName="httpStatus">501</ee:set-variable>
				</ee:variables>
			</ee:transform>
		</on-error-propagate>
		<on-error-propagate enableNotifications="true" logException="true" doc:name="On Error Propagate" doc:id="1036eb6c-83df-4a0f-98a8-c90b3a48d6b2" when="#[(error.muleMessage.typedValue.message) contains 'duplicate']">
			<ee:transform doc:name="payload" doc:id="5451552a-4568-45d6-a36d-0d80381e6eaf" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd" >
				<ee:message >
					<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
{
	message: error.muleMessage.typedValue.message default error.description,
	status: "failed"
}]]></ee:set-payload>
				</ee:message>
				<ee:variables >
					<ee:set-variable variableName="httpStatus" ><![CDATA[500]]></ee:set-variable>
				</ee:variables>
			</ee:transform>
		</on-error-propagate>
		<on-error-propagate enableNotifications="true" logException="true" doc:name="On Error Propagate" doc:id="21786385-6fa6-4039-86ba-994df0e9e6ac" >
			<logger level="ERROR" doc:name="Logger" doc:id="0bfa2b27-8bbc-47a5-bb9c-6e2999542d66" message="#[error.muleMessage.typedValue default error.description]"/>
			<ee:transform doc:name="payload" doc:id="2c85a09e-df1c-42e6-993d-370dfcd49313" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd" >
				<ee:message >
					<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
{
	message: error.muleMessage.typedValue.message default error.description,
	status: "failed"
}]]></ee:set-payload>
				</ee:message>
				<ee:variables >
					<ee:set-variable variableName="httpStatus" ><![CDATA[500]]></ee:set-variable>
				</ee:variables>
			</ee:transform>
		</on-error-propagate>
	</error-handler>
	<error-handler name="batch-error-handler" doc:id="b963407d-bda5-46bd-a58b-1f67baa64e5e" >
		<on-error-propagate enableNotifications="true" logException="true" doc:name="On Error Propagate" doc:id="643f83ba-c685-4b77-a35f-81c73f888e78" >
			<ee:transform doc:name="Transform Message" doc:id="1a4af4bd-099e-490b-a252-fda38b0e5919" >
				<ee:message >
					<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
{
	message: error.description,
	status: "failed"
}]]></ee:set-payload>
				</ee:message>
			</ee:transform>
			<logger level="ERROR" doc:name="Logger" doc:id="e504b61c-d236-4250-a1b9-7dccb8d9006b" message="#[payload]"/>
			<set-variable value="#[p('env') ++ &quot;:ERROR- Job Failed: &quot; ++ (vars.job default '') ++ &quot;,  Check the Mulesoft Logs - &quot; ++ (vars.currentUpdateDate default now() as String {format: &quot;yyyy-MM-dd'T'HH:mm:ss&quot;})]" doc:name="Set subject Variable" doc:id="089865ab-d704-44bf-aef7-426cc1ff8cb4" variableName="subject"/>
			<parse-template doc:name="Parse Template body" doc:id="1cfc9c96-191d-4004-a577-e8fc7f549c3b" location="template/commonresponseHtml.template" target="body"/>
			<flow-ref doc:name="smtp-sub-flow Reference" doc:id="21f5cb1b-3d1d-4b3d-8688-5de5d76bcfa5" name="smtp-sub-flow"/>
		</on-error-propagate>
	</error-handler>

</mule>
